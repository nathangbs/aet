<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciamento de AET</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --brand: #2561C1;
      --brand-dark: #1E4F9E;
      --brand-blue:#1D4ED8;
      --brand-blue-dark:#1E40AF;
      --brand-green:#10B981;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #EFF6FF 0%, #E0E7FF 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: filter 0.3s ease, opacity 0.3s ease;
    }

    .header {
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
      color: white;
      padding: 30px;
    }
    .header-top{
      display:flex;
      align-items:center;
      gap:18px;
    }
    .header-logo{
      width: 150px;
      height: auto;
      background: none;
      padding: 0;
      border-radius: 0;
      object-fit: contain;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,0.35));
    }
    .header h1 { font-size: 32px; margin-bottom: 8px; }

    .tabs {
      display: flex;
      background: #F9FAFB;
      border-bottom: 2px solid #E5E7EB;
    }
    .tab {
      flex: 1;
      padding: 20px;
      background: none;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      color: #6B7280;
      transition: all 0.3s;
    }
    .tab:hover { background: #F3F4F6; }
    .tab.active {
      background: white;
      color: var(--brand);
      border-bottom: 3px solid var(--brand);
    }

    .content { padding: 30px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .map-section {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 20px;
    }

    .sidebar {
      background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
      border-radius: 15px;
      padding: 18px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      height: 800px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sidebar-scroll {
      overflow-y: auto;
      padding: 6px 6px 14px 6px;
    }

    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 12px;
      color: #1F2937;
    }
    .count-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 8px;
      background: #111827;
      color: #fff;
      font-size: 12px;
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      vertical-align: middle;
    }

    .filter-btn {
      width: 100%;
      padding: 15px;
      margin-bottom: 10px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
      background: white;
      color: #374151;
    }
    .filter-btn:hover { background: #EFF6FF; }
    .filter-btn.active {
      background: var(--brand);
      color: white;
      box-shadow: 0 4px 15px rgba(37, 97, 193, 0.30);
    }
    .filter-sub {
      display: block;
      font-weight: 700;
      font-size: 12px;
      opacity: 0.85;
      margin-top: 4px;
    }

    .plate-list {
      max-height: 320px;
      overflow-y: auto;
      padding-right: 6px;
      margin-top: 8px;
    }
    .plate-list::-webkit-scrollbar { width: 10px; }
    .plate-list::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 12px; }
    .plate-list::-webkit-scrollbar-track { background: transparent; }

    .legend {
      border-top: 2px solid #E5E7EB;
      padding-top: 16px;
      margin-top: 16px;
    }
    .legend h3 {
      font-size: 16px;
      margin-bottom: 12px;
      color: #1F2937;
      font-weight: 900;
    }
    .legend-item {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-left: 4px solid;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .legend-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
    }
    .legend-item-name { font-weight: 900; color: #1F2937; margin-bottom: 5px; }
    .legend-item-info { font-size: 14px; color: #6B7280; font-weight: 700; }

    .route-list-scroll {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 6px;
      margin-top: 8px;
    }
    .route-list-scroll::-webkit-scrollbar { width: 10px; }
    .route-list-scroll::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 12px; }
    .route-list-scroll::-webkit-scrollbar-track { background: transparent; }

    .sidebar-footer {
      border-top: 2px solid #E5E7EB;
      padding-top: 14px;
      padding-bottom: 4px;
      background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
      position: sticky;
      bottom: 0;
    }

    .map-wrap {
      position: relative;
      width: 100%;
      height: 800px;
    }
    #map {
      width: 100%;
      height: 800px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .map-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      left: auto;
      z-index: 800;
      background: rgba(17, 24, 39, 0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 14px;
      line-height: 1.1;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      display: none;
      max-width: min(420px, 70%);
      text-align: right;
    }
    .map-badge small {
      display:block;
      margin-top:6px;
      font-weight: 800;
      opacity: .85;
      font-size: 12px;
    }

    .input-group {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      margin-bottom: 20px;
    }

    input, select {
      padding: 12px 15px;
      border: 2px solid #E5E7EB;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
      background: #fff;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--brand);
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary { 
      background: var(--brand-blue); 
      color: white;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 10px 24px rgba(29,78,216,0.20);
    }
    .btn-primary:hover {
      background: var(--brand-blue-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(37, 97, 193, 0.30);
    }
    .btn-primary:disabled{
      opacity: .75;
      cursor: not-allowed;
    }
    .btn-danger { background: #EF4444; color: white; }
    .btn-danger:hover { background: #DC2626; }
    .btn-warn { background: #F59E0B; color: #fff; }
    .btn-warn:hover { background: #D97706; }
    .btn-gray { background: #6B7280; color: #fff; }
    .btn-gray:hover { background: #4B5563; }
    .btn-gray:disabled{
      opacity: .75;
      cursor: not-allowed;
    }
    .btn-dark { background: #111827; color: #fff; }
    .btn-dark:hover { background: #0B1220; }

    .card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-left: 4px solid;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }
    .card-title {
      font-size: 20px;
      font-weight: 900;
      color: #1F2937;
    }
    .card-subtitle {
      color: #6B7280;
      margin-top: 5px;
      font-weight: 700;
    }

    .truck-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    .badge {
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.3s;
      background: #E5E7EB;
      color: #374151;
    }
    .badge:hover { background: #D1D5DB; }
    .badge.active { background: #10B981; color: white; }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    .section-box {
      background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
      padding: 30px;
      border-radius: 15px;
      max-width: 900px;
      margin: 0 auto;
    }
    .list-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      gap: 10px;
    }
    .list-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .empty-state {
      text-align: center;
      padding: 30px 10px;
      color: #9CA3AF;
      font-style: italic;
      font-weight: 700;
    }
    .mini-status {
      background: #fff;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      font-size: 14px;
      color: #374151;
      line-height: 1.35;
      font-weight: 700;
    }
    .mini-status strong { color: #111827; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
    }
    .modal-backdrop.active { display: flex; }
    .modal {
      width: min(1100px, 96vw);
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .modal-header {
      display:flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 18px;
      background: #F9FAFB;
      border-bottom: 1px solid #E5E7EB;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 950;
      color: #111827;
    }
    .modal-body { padding: 14px 18px 18px 18px; }

    #osrm-modal-map {
      width: 100%;
      height: 520px;
      border-radius: 14px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .modal-actions {
      display:flex;
      gap: 10px;
      margin-top: 12px;
    }

    .popup {
      width: min(520px, 96vw);
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .popup-body {
      padding: 18px;
      color: #111827;
      font-weight: 800;
      line-height: 1.35;
    }
    .popup-actions {
      padding: 14px 18px 18px 18px;
      display:flex;
      justify-content: flex-end;
      gap: 10px;
      background: #F9FAFB;
      border-top: 1px solid #E5E7EB;
    }

    #auth-modal .modal{
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 24px 70px rgba(0,0,0,0.28);
    }

    #auth-modal .auth-header{
      padding: 10px 20px 10px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      border-bottom: 1px solid #E5E7EB;
    }

    #auth-modal .auth-logo{
      width: 140px;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,0.18));
      margin-top: 0;
      margin-bottom: 2px;
    }

    #auth-modal .auth-title{
      font-size: 18px;
      font-weight: 950;
      color: #0F172A;
      letter-spacing: -0.2px;
      margin-top: 0;
    }

    #auth-modal .auth-subtitle{
      font-size: 12px;
      font-weight: 900;
      color: #64748B;
      text-align: center;
      line-height: 1.35;
      margin-top: -4px;
    }

    #auth-modal .modal-body{
      padding-top: 16px;
    }

    #auth-modal input{
      border-radius: 12px;
    }

    #auth-modal .modal-actions button{
      border-radius: 12px;
    }

    #auth-modal .mini-status{
      border-radius: 12px;
    }

    .spinner{
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.55);
      border-top-color: rgba(255,255,255,0.95);
      display: inline-block;
      animation: spin 0.85s linear infinite;
      vertical-align: -3px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .btn-loading{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // === Supabase init ===
    window.supabaseClient = window.supabase.createClient(
      "https://nhvprvgxnlrfulztxcnk.supabase.co", 
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5odnBydmd4bmxyZnVsenR4Y25rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjU0MjQsImV4cCI6MjA4MjM0MTQyNH0.al3zG6OkC5uLe4MLEZeTErmSty-N3yG9rKVDC7FIVWU"
    );
  </script>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <img class="header-logo"
          src="https://cdn-sites-assets.mziq.com/wp-content/uploads/sites/1475/2025/05/AnyConv.com__Camada_11-1.webp"
          alt="Logo">
        <div>
          <h1>Gerenciamento de Autoriza√ß√£o Especial de Tr√¢nsito</h1>
          <p>Controle trechos autorizados por ve√≠culo</p>
          <div style="margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span style="background:rgba(255,255,255,0.18); padding:8px 12px; border-radius:999px; font-weight:900;">
              üë§ <span id="user-badge">Deslogado</span>
            </span>
            <button id="btn-logout" class="btn btn-dark" style="display:none;">Sair</button>
          </div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab(event,'map')">üó∫Ô∏è Mapa e Filtros</button>
      <button class="tab" onclick="showTab(event,'trucks')">üöõ Placas</button>
      <button class="tab" onclick="showTab(event,'routes')">üìç Trechos</button>
    </div>

    <div class="content">
      <div id="tab-map" class="tab-content active">
        <div class="map-section">
          <div class="sidebar">
            <div class="sidebar-scroll">
              <h2>
                üöõ Filtrar por Placa
                <span class="count-pill">Placas: <span id="plates-count">0</span></span>
              </h2>

              <div style="margin-bottom: 12px;">
                <select id="company-filter" style="width:100%;" onchange="onCompanyFilterChange()">
                  <option value="ALL">Todas as Empresas</option>
                  <option value="POTENCIAL">POTENCIAL</option>
                  <option value="BWT">BWT</option>
                </select>
              </div>

              <div style="margin-bottom: 10px;">
                <input id="plate-search" type="text" placeholder="Buscar placa..." oninput="renderFilters()" style="width:100%;">
              </div>

              <button id="btn-all-routes" class="filter-btn" onclick="selectTruckFilter(null)">
                Todos os Trechos
                <span class="filter-sub" id="all-routes-sub">Sem filtro de placa</span>
              </button>

              <div id="filter-buttons" class="plate-list"></div>

              <div class="legend">
                <h3>
                  Trechos Autorizados
                  <span class="count-pill">Trechos: <span id="routes-count">0</span></span>
                </h3>

                <div class="route-list-scroll">
                  <div id="legend-items"></div>
                </div>
              </div>
            </div>

            <div class="sidebar-footer">
              <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1;" onclick="fitToFilteredRoutes()">üó∫Ô∏è Enquadrar</button>
                <button class="btn btn-gray" style="flex:1;" onclick="resetMapView()">Reset</button>
              </div>
            </div>
          </div>

          <div class="map-wrap">
            <div id="map"></div>
            <div id="map-filter-badge" class="map-badge"></div>
          </div>
        </div>
      </div>

      <div id="tab-trucks" class="tab-content">
        <div class="section-box">
          <h2 style="margin-bottom: 20px;">Gerenciar Placas</h2>

          <div class="input-group" style="grid-template-columns: 220px 1fr auto;">
            <select id="new-truck-company">
              <option value="POTENCIAL">POTENCIAL</option>
              <option value="BWT">BWT</option>
            </select>

            <input type="text" id="new-truck" placeholder="Digite a placa (ex: ABC-1234)" />
            <button class="btn btn-primary" onclick="addTruck()">‚ûï Adicionar</button>
          </div>

          <div class="mini-status" style="margin-top:-6px; margin-bottom: 16px;">
            <strong>Regra:</strong> n√£o √© permitido cadastrar a <strong>mesma placa</strong> duas vezes.
          </div>

          <div id="truck-list"></div>
        </div>
      </div>

      <div id="tab-routes" class="tab-content">
        <div class="section-box">
          <h2 style="margin-bottom: 20px;">Novo Trecho</h2>

          <div style="display:flex; gap:10px; margin-bottom: 15px;">
            <button class="btn btn-dark" style="flex:1;" onclick="openOsrmModal()">üéØ Selecionar no mapa</button>
          </div>

          <div class="form-grid">
            <input type="text" id="route-name" placeholder="Nome do trecho" />
            <select id="route-state"><option value="">Selecione o Estado</option></select>
            <input type="text" id="route-highway" placeholder="Rodovia (ex: BR-101)" />
            <input type="color" id="route-color" value="#3B82F6" />
            <input type="text" id="route-start" placeholder="In√≠cio (opcional)" />
            <input type="text" id="route-end" placeholder="Fim (opcional)" />
          </div>

          <button id="btn-save-route" class="btn btn-primary" onclick="saveRoute()" style="width: 100%;">‚ûï Adicionar Trecho</button>
          <button id="btn-cancel-edit" class="btn btn-gray" onclick="cancelEdit()" style="width: 100%; margin-top: 10px; display:none;">‚Ü© Cancelar Edi√ß√£o</button>

          <div class="mini-status">
            <strong>Dica:</strong> clique em <strong>Selecionar no mapa</strong>, marque <strong>In√≠cio</strong> e <strong>Fim</strong>.
            O trecho ficar√° <strong>exato na rodovia</strong> e destacado.
          </div>
        </div>

        <div style="margin-top: 30px;" id="route-list"></div>

        <div id="osrm-modal" class="modal-backdrop" onclick="closeOsrmModalOnBackdrop(event)">
          <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
              <div class="modal-title">üó∫Ô∏è Selecionar trecho exato na rodovia (OSRM)</div>
              <button class="btn btn-gray" onclick="closeOsrmModal()">‚úñ Fechar</button>
            </div>

            <div class="modal-body">
              <div id="osrm-modal-map"></div>

              <div id="osrm-status" class="mini-status">
                Clique em <strong>Iniciar sele√ß√£o</strong> para marcar In√≠cio e Fim do trecho.
              </div>

              <div class="modal-actions">
                <button class="btn btn-primary" onclick="startOsrmSelection()" style="flex:1;">‚ñ∂Ô∏è Iniciar sele√ß√£o</button>
                <button class="btn btn-warn" onclick="cancelOsrmSelection()" style="flex:1;">üö´ Cancelar sele√ß√£o</button>
                <button class="btn btn-dark" onclick="fitTempOrLastRoute()" style="flex:1;">üîç Enquadrar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="dup-plate-modal" class="modal-backdrop" onclick="closeDupPlateOnBackdrop(event)">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">‚ö†Ô∏è Placa j√° cadastrada</div>
        <button class="btn btn-gray" onclick="closeDupPlateModal()">‚úñ</button>
      </div>
      <div class="popup-body" id="dup-plate-text">
        Essa placa j√° est√° cadastrada.
      </div>
      <div class="popup-actions">
        <button class="btn btn-primary" onclick="closeDupPlateModal()">OK</button>
      </div>
    </div>
  </div>

  <div id="auth-modal" class="modal-backdrop active" onclick="/* bloquear clique fora */">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:540px;">
      <div class="modal-header auth-header">
        <img class="auth-logo" src="https://vivaintra-s3-potencial.s3.amazonaws.com/temp/d39ad6a1bff5ed678d5ae138c597b8d5c3df5993.png" alt="Grupo Potencial">
        <div class="auth-title">Acesso ao Sistema</div>
        <div class="auth-subtitle">Gerenciamento de Autoriza√ß√£o Especial de Tr√¢nsito</div>
      </div>
      <div class="modal-body">
        <div class="mini-status" style="margin-top:0;">
          Entre com seu e-mail e senha.
        </div>

        <div style="display:grid; gap:10px; margin-top:14px;">
          <input id="auth-email" type="email" placeholder="E-mail" autocomplete="email" />
          <input id="auth-password" type="password" placeholder="Senha" autocomplete="current-password" />
        </div>

        <div id="auth-status" class="mini-status" style="margin-top:14px; color:#374151; display:none;"></div>
      </div>
      
      <div class="modal-actions" style="padding: 0 18px 18px 18px;">
        <button id="auth-login-btn" class="btn btn-primary" style="width:100%;">Entrar</button>
      </div>
    </div>
  </div>

  <script>
    var states = {
      'AC': [-9.0238, -70.812], 'AL': [-9.5713, -36.782], 'AM': [-3.4168, -65.856], 'AP': [0.9020, -52.003],
      'BA': [-12.5797, -41.700], 'CE': [-5.4984, -39.320], 'DF': [-15.7939, -47.882], 'ES': [-19.1834, -40.308],
      'GO': [-15.8270, -49.837], 'MA': [-4.9609, -45.274], 'MG': [-18.5122, -44.555], 'MS': [-20.7722, -54.785],
      'MT': [-12.6819, -56.921], 'PA': [-1.9981, -54.930], 'PB': [-7.2399, -36.782], 'PE': [-8.8137, -36.954],
      'PI': [-7.7183, -42.728], 'PR': [-24.8994, -51.430], 'RJ': [-22.2543, -42.652], 'RN': [-5.4026, -36.954],
      'RO': [-10.8312, -63.341], 'RR': [2.7376, -62.073], 'RS': [-30.0346, -51.217], 'SC': [-27.2423, -50.218],
      'SE': [-10.5741, -37.386], 'SP': [-22.1987, -48.638], 'TO': [-10.1753, -48.291]
    };

    var trucks = [];
    var routes = [];
    var selectedTruck = null;
    var selectedCompany = "ALL";

    var map = null;
    var layers = [];
    var mapRouteLayers = {};

    var editingRouteId = null;

    var osrmModalMap = null;
    var osrmModalReady = false;
    var osrmSelecting = false;
    var osrmStage = 0;
    var osrmStart = null;
    var osrmEnd = null;
    var osrmStartMarker = null;
    var osrmEndMarker = null;
    var osrmTempRouteLayer = null;

    var pendingGeometry = null;
    var pendingDistanceKm = null;

    var OSRM_BASE = "https://router.project-osrm.org";

    window.onload = function() {
      map = L.map('map').setView([-14.2350, -51.9253], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      var sel = document.getElementById('route-state');
      var stateKeys = Object.keys(states).sort();
      for (var i = 0; i < stateKeys.length; i++) {
        var opt = document.createElement('option');
        opt.value = stateKeys[i];
        opt.textContent = stateKeys[i];
        sel.appendChild(opt);
      }

      renderAll();
    };

    function showTab(ev, name) {
      var tabs = document.querySelectorAll('.tab');
      var contents = document.querySelectorAll('.tab-content');
      for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
      for (var i = 0; i < contents.length; i++) contents[i].classList.remove('active');

      ev.currentTarget.classList.add('active');
      document.getElementById('tab-' + name).classList.add('active');

      if (name === 'map' && map) setTimeout(function(){ map.invalidateSize(); }, 150);
    }

    function resetMapView() {
      map.setView([-14.2350, -51.9253], 4);
    }

    function fitToFilteredRoutes() {
      var filtered = getFilteredRoutes();
      var pts = [];
      for (var i = 0; i < filtered.length; i++) {
        if (filtered[i].geometry && filtered[i].geometry.length >= 2) pts = pts.concat(filtered[i].geometry);
      }
      if (pts.length >= 2) map.fitBounds(L.latLngBounds(pts), { padding: [50, 50] });
      else resetMapView();
    }

    function onCompanyFilterChange() {
      selectedCompany = document.getElementById('company-filter').value || "ALL";
      if (selectedTruck && selectedCompany !== "ALL" && selectedTruck.company !== selectedCompany) {
        selectedTruck = null;
      }
      renderAll();
    }

    function openDupPlateModal(plate) {
      document.getElementById('dup-plate-text').innerHTML =
        'A placa <strong>' + plate + '</strong> j√° est√° cadastrada.<br><br>Clique em <strong>OK</strong> para voltar.';
      document.getElementById('dup-plate-modal').classList.add('active');
    }
    function closeDupPlateModal() {
      document.getElementById('dup-plate-modal').classList.remove('active');
    }
    function closeDupPlateOnBackdrop(ev) {
      if (ev.target && ev.target.id === 'dup-plate-modal') closeDupPlateModal();
    }

    function addTruck() {
      var input = document.getElementById('new-truck');
      var plate = input.value.trim().toUpperCase();
      var company = (document.getElementById('new-truck-company').value || "POTENCIAL").toUpperCase();
      if (!plate) return;

      for (var i = 0; i < trucks.length; i++) {
        if (trucks[i].plate === plate) {
          openDupPlateModal(plate);
          return;
        }
      }

      trucks.push({ id: Date.now(), plate: plate, company: company });
      input.value = '';
      renderAll();
    }

    function removeTruck(id) {
      var newTrucks = [];
      for (var i = 0; i < trucks.length; i++) if (trucks[i].id !== id) newTrucks.push(trucks[i]);
      trucks = newTrucks;

      if (selectedTruck && selectedTruck.id === id) selectedTruck = null;

      for (var r = 0; r < routes.length; r++) {
        var a = routes[r].allowedTrucks;
        var na = [];
        for (var j = 0; j < a.length; j++) if (a[j] !== id) na.push(a[j]);
        routes[r].allowedTrucks = na;
      }

      renderAll();
    }

    function saveRoute() {
      var name = document.getElementById('route-name').value.trim();
      var state = document.getElementById('route-state').value;
      var highway = document.getElementById('route-highway').value.trim();
      var color = document.getElementById('route-color').value;
      var startTxt = document.getElementById('route-start').value.trim();
      var endTxt = document.getElementById('route-end').value.trim();
      if (!name || !state || !highway) return;

      if (editingRouteId) {
        for (var i = 0; i < routes.length; i++) {
          if (routes[i].id === editingRouteId) {
            routes[i].name = name;
            routes[i].state = state;
            routes[i].highway = highway;
            routes[i].color = color;
            routes[i].start = startTxt;
            routes[i].end = endTxt;

            if (pendingGeometry && pendingGeometry.length >= 2) {
              routes[i].geometry = pendingGeometry.slice();
              routes[i].distanceKm = pendingDistanceKm;
            }
            break;
          }
        }
      } else {
        routes.push({
          id: Date.now(),
          name: name,
          state: state,
          highway: highway,
          color: color,
          start: startTxt,
          end: endTxt,
          allowedTrucks: [],
          geometry: (pendingGeometry && pendingGeometry.length >= 2) ? pendingGeometry.slice() : null,
          distanceKm: pendingDistanceKm
        });
      }

      pendingGeometry = null;
      pendingDistanceKm = null;
      clearOsrmTemp();
      clearRouteForm();
      editingRouteId = null;
      renderAll();
    }

    function editRoute(id) {
      for (var i = 0; i < routes.length; i++) {
        if (routes[i].id === id) {
          var r = routes[i];
          editingRouteId = id;

          document.getElementById('route-name').value = r.name;
          document.getElementById('route-state').value = r.state;
          document.getElementById('route-highway').value = r.highway;
          document.getElementById('route-color').value = r.color;
          document.getElementById('route-start').value = r.start || '';
          document.getElementById('route-end').value = r.end || '';

          document.getElementById('btn-save-route').textContent = 'üíæ Salvar Altera√ß√µes';
          document.getElementById('btn-cancel-edit').style.display = 'block';

          pendingGeometry = null;
          pendingDistanceKm = null;
          clearOsrmTemp();

          renderAll();
          break;
        }
      }
    }

    function cancelEdit() {
      editingRouteId = null;
      clearRouteForm();
      pendingGeometry = null;
      pendingDistanceKm = null;
      clearOsrmTemp();
      renderAll();
    }

    function deleteRoute(id) {
      var newRoutes = [];
      for (var i = 0; i < routes.length; i++) if (routes[i].id !== id) newRoutes.push(routes[i]);
      routes = newRoutes;

      if (editingRouteId === id) cancelEdit();
      renderAll();
    }

    function clearRouteForm() {
      document.getElementById('route-name').value = '';
      document.getElementById('route-state').value = '';
      document.getElementById('route-highway').value = '';
      document.getElementById('route-start').value = '';
      document.getElementById('route-end').value = '';

      document.getElementById('btn-save-route').textContent = '‚ûï Adicionar Trecho';
      document.getElementById('btn-cancel-edit').style.display = 'none';
    }

    function toggleTruck(routeId, truckId) {
      for (var i = 0; i < routes.length; i++) {
        if (routes[i].id === routeId) {
          var allowed = routes[i].allowedTrucks;
          var idx = -1;
          for (var j = 0; j < allowed.length; j++) if (allowed[j] === truckId) { idx = j; break; }
          if (idx >= 0) allowed.splice(idx, 1);
          else allowed.push(truckId);
          break;
        }
      }
      renderAll();
    }

    function selectTruckFilter(id) {
      selectedTruck = null;
      if (id !== null) {
        for (var i = 0; i < trucks.length; i++) if (trucks[i].id === id) { selectedTruck = trucks[i]; break; }
      }
      renderAll();
    }

    function getTrucksByCompany(company) {
      if (company === "ALL") return trucks.slice();
      var arr = [];
      for (var i = 0; i < trucks.length; i++) if (trucks[i].company === company) arr.push(trucks[i]);
      return arr;
    }

    function getFilteredRoutes() {
      if (selectedTruck) {
        var filtered = [];
        for (var i = 0; i < routes.length; i++) {
          var allowed = routes[i].allowedTrucks;
          for (var j = 0; j < allowed.length; j++) if (allowed[j] === selectedTruck.id) { filtered.push(routes[i]); break; }
        }
        return filtered;
      }

      if (selectedCompany !== "ALL") {
        var trucksOfCompany = getTrucksByCompany(selectedCompany);
        var setIds = {};
        for (var t = 0; t < trucksOfCompany.length; t++) setIds[trucksOfCompany[t].id] = true;

        var filtered2 = [];
        for (var r = 0; r < routes.length; r++) {
          var allowed2 = routes[r].allowedTrucks;
          var ok = false;
          for (var a = 0; a < allowed2.length; a++) if (setIds[allowed2[a]]) { ok = true; break; }
          if (ok) filtered2.push(routes[r]);
        }
        return filtered2;
      }

      return routes;
    }

    function updateMapBadge() {
      var badge = document.getElementById('map-filter-badge');

      if (selectedTruck) {
        badge.innerHTML = "Filtro: " + selectedTruck.plate + "<small>Empresa: " + selectedTruck.company + "</small>";
        badge.style.display = "block";
        return;
      }
      if (selectedCompany !== "ALL") {
        badge.innerHTML = "Filtro: Empresa " + selectedCompany + "<small>Placa: (todas)</small>";
        badge.style.display = "block";
        return;
      }
      badge.style.display = "none";
    }

    function updateAllButtonActiveState() {
      var btnAll = document.getElementById('btn-all-routes');
      if (!btnAll) return;
      btnAll.classList.toggle('active', !selectedTruck);
    }

    function highlightRoute(routeId, on) {
      var obj = mapRouteLayers[routeId];
      if (!obj || !obj.line) return;

      if (on) {
        obj.line.setStyle({ weight: 10, opacity: 1.0 });
        if (obj.line.bringToFront) obj.line.bringToFront();
        if (obj.markers) {
          for (var i = 0; i < obj.markers.length; i++) {
            if (obj.markers[i] && obj.markers[i].bringToFront) obj.markers[i].bringToFront();
          }
        }
      } else {
        obj.line.setStyle({ weight: obj.base.weight, opacity: obj.base.opacity });
      }
    }

    function renderAll() {
      renderFilters();
      renderLegend();
      renderMap();
      renderTrucks();
      renderRoutes();
      updateMapBadge();
      updateAllButtonActiveState();
    }

    function renderFilters() {
      var q = (document.getElementById('plate-search') ? document.getElementById('plate-search').value : '')
        .trim().toUpperCase();

      var list = trucks.slice();
      list.sort(function(a, b) {
        if (a.plate < b.plate) return -1;
        if (a.plate > b.plate) return 1;
        return 0;
      });

      if (selectedCompany !== "ALL") {
        var tmp = [];
        for (var i = 0; i < list.length; i++) if (list[i].company === selectedCompany) tmp.push(list[i]);
        list = tmp;
      }

      if (q) {
        var tmp2 = [];
        for (var i2 = 0; i2 < list.length; i2++) if (list[i2].plate.indexOf(q) !== -1) tmp2.push(list[i2]);
        list = tmp2;
      }

      document.getElementById('plates-count').textContent = String(list.length);

      var allSub = document.getElementById('all-routes-sub');
      if (allSub) {
        if (selectedTruck) allSub.textContent = "Empresa: " + selectedTruck.company + " ‚Ä¢ Placa: " + selectedTruck.plate;
        else allSub.textContent = (selectedCompany === "ALL") ? "Sem filtro de placa" : ("Empresa: " + selectedCompany + " ‚Ä¢ Placa: todas");
      }

      var html = '';
      if (list.length === 0) {
        html = '<p class="empty-state" style="padding:16px;">Nenhuma placa encontrada</p>';
      } else {
        for (var i3 = 0; i3 < list.length; i3++) {
          var t = list[i3];
          var active = selectedTruck && selectedTruck.id === t.id;

          html += '<button class="filter-btn ' + (active ? 'active' : '') + '" onclick="selectTruckFilter(' + t.id + ')">';
          html += t.plate;
          html += '<span class="filter-sub">Empresa: ' + t.company + '</span>';
          html += '</button>';
        }
      }
      document.getElementById('filter-buttons').innerHTML = html;
    }

    function renderLegend() {
      var filtered = getFilteredRoutes();
      document.getElementById('routes-count').textContent = String(filtered.length);

      var html = '';
      if (filtered.length === 0) {
        html = '<p class="empty-state">Nenhum trecho encontrado</p>';
      } else {
        for (var i = 0; i < filtered.length; i++) {
          var r = filtered[i];
          var extra = (r.distanceKm != null) ? (' ‚Ä¢ ' + r.distanceKm.toFixed(1) + ' km') : '';
          html += '<div class="legend-item" data-route-id="' + r.id + '" style="border-left-color: ' + r.color + ';">';
          html +=   '<div class="legend-item-name">' + r.name + '</div>';
          html +=   '<div class="legend-item-info">' + r.highway + ' - ' + r.state + extra + '</div>';
          if (r.start && r.end) html += '<div class="legend-item-info">' + r.start + ' ‚Üí ' + r.end + '</div>';
          html += '</div>';
        }
      }
      document.getElementById('legend-items').innerHTML = html;

      var items = document.querySelectorAll('#legend-items .legend-item');
      for (var j = 0; j < items.length; j++) {
        (function(el){
          var id = Number(el.getAttribute('data-route-id'));
          el.addEventListener('mouseenter', function(){ highlightRoute(id, true); });
          el.addEventListener('mouseleave', function(){ highlightRoute(id, false); });
          el.addEventListener('click', function(){
            var rr = getRouteById(id);
            if (rr && rr.geometry && rr.geometry.length >= 2) {
              map.fitBounds(L.latLngBounds(rr.geometry), { padding: [50, 50] });
            }
          });
        })(items[j]);
      }
    }

    function renderMap() {
      for (var i = 0; i < layers.length; i++) map.removeLayer(layers[i]);
      layers = [];
      mapRouteLayers = {};

      var filtered = getFilteredRoutes();
      if (filtered.length === 0) { resetMapView(); return; }

      var boundsPts = [];
      for (var i2 = 0; i2 < filtered.length; i2++) {
        var r = filtered[i2];

        if (r.geometry && r.geometry.length >= 2) {
          var baseStyle = { weight: 6, opacity: 0.85 };

          var line = L.polyline(r.geometry, { color: r.color, weight: baseStyle.weight, opacity: baseStyle.opacity }).addTo(map);
          layers.push(line);

          var m1 = L.circleMarker(r.geometry[0], { radius: 7, fillColor: r.color, color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map);
          var m2 = L.circleMarker(r.geometry[r.geometry.length - 1], { radius: 7, fillColor: r.color, color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map);
          layers.push(m1); layers.push(m2);

          mapRouteLayers[r.id] = { line: line, markers: [m1,m2], base: baseStyle };

          for (var b = 0; b < r.geometry.length; b++) boundsPts.push(r.geometry[b]);

          var popup = '<div><h3 style="color:' + r.color + '; margin:0 0 6px 0;">' + r.name + '</h3><p style="margin:0;">' + r.highway + ' - ' + r.state + '</p>';
          if (r.start && r.end) popup += '<p style="margin:6px 0 0 0;">' + r.start + ' ‚Üí ' + r.end + '</p>';
          if (r.distanceKm != null) popup += '<p style="margin:6px 0 0 0;"><strong>' + r.distanceKm.toFixed(1) + ' km</strong></p>';
          popup += '</div>';
          line.bindPopup(popup);

          line.on('mouseover', (function(id){ return function(){ highlightRoute(id, true); }; })(r.id));
          line.on('mouseout',  (function(id){ return function(){ highlightRoute(id, false); }; })(r.id));
        } else {
          var coord = states[r.state];
          if (!coord) continue;

          var start = [coord[0] - 0.8, coord[1] - 0.8];
          var end = [coord[0] + 0.8, coord[1] + 0.8];
          boundsPts.push(start, end);

          var line2 = L.polyline([start, end], { color: r.color, weight: 6, opacity: 0.8 }).addTo(map);
          layers.push(line2);

          mapRouteLayers[r.id] = { line: line2, markers: [], base: { weight: 6, opacity: 0.8 } };

          line2.on('mouseover', (function(id){ return function(){ highlightRoute(id, true); }; })(r.id));
          line2.on('mouseout',  (function(id){ return function(){ highlightRoute(id, false); }; })(r.id));
        }
      }

      if (boundsPts.length > 0) map.fitBounds(L.latLngBounds(boundsPts), { padding: [50, 50] });
    }

    function renderTrucks() {
      var html = '';
      if (trucks.length === 0) {
        html = '<p class="empty-state">Nenhuma placa cadastrada</p>';
      } else {
        var list = trucks.slice();
        list.sort(function(a,b){ return (a.plate < b.plate) ? -1 : (a.plate > b.plate) ? 1 : 0; });

        for (var i = 0; i < list.length; i++) {
          html += '<div class="list-item">';
          html +=   '<div>';
          html +=     '<div style="font-size:18px;font-weight:950; color:#111827;">' + list[i].plate + '</div>';
          html +=     '<div style="font-size:12px; font-weight:900; color:#6B7280; margin-top:4px;">Empresa: ' + list[i].company + '</div>';
          html +=   '</div>';
          html +=   '<button class="btn btn-danger" onclick="removeTruck(' + list[i].id + ')">üóëÔ∏è Remover</button>';
          html += '</div>';
        }
      }
      document.getElementById('truck-list').innerHTML = html;
    }

    function renderRoutes() {
      var html = '';
      if (routes.length === 0) {
        html = '<p class="empty-state">Nenhum trecho cadastrado</p>';
      } else {
        for (var i = 0; i < routes.length; i++) {
          var r = routes[i];
          html += '<div class="card" style="border-left-color:' + r.color + '"><div class="card-header"><div>';
          html += '<div class="card-title">' + r.name + '</div>';

          var dist = (r.distanceKm != null) ? (' ‚Ä¢ ' + r.distanceKm.toFixed(1) + ' km') : '';
          html += '<div class="card-subtitle">' + r.highway + ' - ' + r.state + dist + '</div>';

          if (r.start && r.end) html += '<div class="card-subtitle">' + r.start + ' ‚Üí ' + r.end + '</div>';

          var geoOk = (r.geometry && r.geometry.length >= 2) ? '‚úÖ Tra√ßado real' : '‚ö† Sem tra√ßado (use "Selecionar no mapa")';
          html += '<div class="card-subtitle" style="margin-top:8px;"><strong>' + geoOk + '</strong></div>';

          html += '</div><div style="display:flex; gap:10px;">';
          html += '<button class="btn btn-warn" onclick="editRoute(' + r.id + ')">‚úèÔ∏è</button>';
          html += '<button class="btn btn-danger" onclick="deleteRoute(' + r.id + ')">üóëÔ∏è</button>';
          html += '</div></div>';

          html += '<div><strong>Placas Autorizadas:</strong><div class="truck-badges">';
          for (var j = 0; j < trucks.length; j++) {
            var hasPermission = false;
            for (var k = 0; k < r.allowedTrucks.length; k++) if (r.allowedTrucks[k] === trucks[j].id) { hasPermission = true; break; }
            html += '<span class="badge ' + (hasPermission ? 'active' : '') + '" onclick="toggleTruck(' + r.id + ',' + trucks[j].id + ')">';
            html += trucks[j].plate + '</span>';
          }
          html += '</div></div></div>';
        }
      }
      document.getElementById('route-list').innerHTML = html;
    }

    function openOsrmModal() {
      var modal = document.getElementById('osrm-modal');
      modal.classList.add('active');

      if (!osrmModalReady) {
        osrmModalMap = L.map('osrm-modal-map').setView([-14.2350, -51.9253], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap'
        }).addTo(osrmModalMap);

        osrmModalMap.on('click', function(e) {
          if (!osrmSelecting) return;
          if (osrmStage === 0) setOsrmStart(e.latlng);
          else if (osrmStage === 1) { setOsrmEnd(e.latlng); fetchOsrmRoute(osrmStart, osrmEnd); }
        });

        osrmModalReady = true;
      }

      setTimeout(function() {
        osrmModalMap.invalidateSize();

        if (editingRouteId) {
          var r = getRouteById(editingRouteId);
          if (r && r.geometry && r.geometry.length >= 2) {
            drawTempRoute(r.geometry, r.color);
            fitCoords(r.geometry);
            setOsrmStatus("Edi√ß√£o ativa: clique em <strong>Iniciar sele√ß√£o</strong> para marcar novo In√≠cio/Fim e substituir o tra√ßado.");
          } else {
            setOsrmStatus("Clique em <strong>Iniciar sele√ß√£o</strong> e marque In√≠cio e Fim.");
          }
        } else if (pendingGeometry && pendingGeometry.length >= 2) {
          drawTempRoute(pendingGeometry, document.getElementById('route-color').value || '#3B82F6');
          fitCoords(pendingGeometry);
          setOsrmStatus("Trecho j√° calculado. Voc√™ pode clicar em <strong>Adicionar / Salvar</strong>.");
        } else {
          setOsrmStatus("Clique em <strong>Iniciar sele√ß√£o</strong> e marque In√≠cio e Fim.");
          osrmModalMap.setView([-14.2350, -51.9253], 4);
        }
      }, 150);
    }

    function closeOsrmModal() { document.getElementById('osrm-modal').classList.remove('active'); }
    function closeOsrmModalOnBackdrop(ev) { if (ev.target && ev.target.id === 'osrm-modal') closeOsrmModal(); }
    function setOsrmStatus(html) { document.getElementById('osrm-status').innerHTML = html; }

    function startOsrmSelection() {
      osrmSelecting = true; osrmStage = 0; osrmStart = null; osrmEnd = null;
      pendingGeometry = null; pendingDistanceKm = null;
      clearOsrmTemp();
      setOsrmStatus("Sele√ß√£o ativa: clique no mapa para marcar o <strong>IN√çCIO</strong> do trecho.");
    }

    function cancelOsrmSelection() {
      osrmSelecting = false; osrmStage = 0; osrmStart = null; osrmEnd = null;
      pendingGeometry = null; pendingDistanceKm = null;
      clearOsrmTemp();
      setOsrmStatus("Sele√ß√£o cancelada.");
    }

    function setOsrmStart(latlng) {
      osrmStart = latlng; osrmStage = 1;
      if (osrmStartMarker) osrmModalMap.removeLayer(osrmStartMarker);
      osrmStartMarker = L.circleMarker(latlng, { radius: 9, fillColor: "#10B981", color: "#fff", weight: 2, fillOpacity: 1 })
        .addTo(osrmModalMap).bindPopup("In√≠cio");
      setOsrmStatus("In√≠cio marcado. Agora clique no mapa para marcar o <strong>FIM</strong>.");
    }

    function setOsrmEnd(latlng) {
      osrmEnd = latlng;
      if (osrmEndMarker) osrmModalMap.removeLayer(osrmEndMarker);
      osrmEndMarker = L.circleMarker(latlng, {
      
