<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciamento de AET</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --brand: #2561C1;
      --brand-dark: #1E4F9E;
      --brand-blue:#1D4ED8;
      --brand-blue-dark:#1E40AF;
      --brand-green:#10B981;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #EFF6FF 0%, #E0E7FF 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: filter 0.3s ease, opacity 0.3s ease;
    }

    .header {
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
      color: white;
      padding: 30px;
    }
    .header-top{
      display:flex;
      align-items:center;
      gap:18px;
    }
    .header-logo{
      width: 150px;
      height: auto;
      background: none;
      padding: 0;
      border-radius: 0;
      object-fit: contain;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,0.35));
    }
    .header h1 { font-size: 32px; margin-bottom: 8px; }

    .tabs {
      display: flex;
      background: #F9FAFB;
      border-bottom: 2px solid #E5E7EB;
    }
    .tab {
      flex: 1;
      padding: 20px;
      background: none;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      color: #6B7280;
      transition: all 0.3s;
    }
    .tab:hover { background: #F3F4F6; }
    .tab.active {
      background: white;
      color: var(--brand);
      border-bottom: 3px solid var(--brand);
    }

    .content { padding: 30px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .map-section {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 20px;
    }

    .sidebar {
      background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
      border-radius: 15px;
      padding: 18px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      height: 800px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sidebar-scroll {
      overflow-y: auto;
      padding: 6px 6px 14px 6px;
    }

    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 12px;
      color: #1F2937;
    }
    .count-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 8px;
      background: #111827;
      color: #fff;
      font-size: 12px;
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      vertical-align: middle;
    }

    .filter-btn {
      width: 100%;
      padding: 15px;
      margin-bottom: 10px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
      background: white;
      color: #374151;
    }
    .filter-btn:hover { background: #EFF6FF; }
    .filter-btn.active {
      background: var(--brand);
      color: white;
      box-shadow: 0 4px 15px rgba(37, 97, 193, 0.30);
    }
    .filter-sub {
      display: block;
      font-weight: 700;
      font-size: 12px;
      opacity: 0.85;
      margin-top: 4px;
    }

    .plate-list {
      max-height: 320px;
      overflow-y: auto;
      padding-right: 6px;
      margin-top: 8px;
    }
    .plate-list::-webkit-scrollbar { width: 10px; }
    .plate-list::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 12px; }
    .plate-list::-webkit-scrollbar-track { background: transparent; }

    .legend {
      border-top: 2px solid #E5E7EB;
      padding-top: 16px;
      margin-top: 16px;
    }
    .legend h3 {
      font-size: 16px;
      margin-bottom: 12px;
      color: #1F2937;
      font-weight: 900;
    }
    .legend-item {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-left: 4px solid;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .legend-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
    }
    .legend-item-name { font-weight: 900; color: #1F2937; margin-bottom: 5px; }
    .legend-item-info { font-size: 14px; color: #6B7280; font-weight: 700; }

    .route-list-scroll {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 6px;
      margin-top: 8px;
    }
    .route-list-scroll::-webkit-scrollbar { width: 10px; }
    .route-list-scroll::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 12px; }
    .route-list-scroll::-webkit-scrollbar-track { background: transparent; }

    .sidebar-footer {
      border-top: 2px solid #E5E7EB;
      padding-top: 14px;
      padding-bottom: 4px;
      background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
      position: sticky;
      bottom: 0;
    }

    .map-wrap {
      position: relative;
      width: 100%;
      height: 800px;
    }
    #map {
      width: 100%;
      height: 800px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .map-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      left: auto;
      z-index: 800;
      background: rgba(17, 24, 39, 0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 14px;
      line-height: 1.1;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      display: none;
      max-width: min(420px, 70%);
      text-align: right;
    }
    .map-badge small {
      display:block;
      margin-top:6px;
      font-weight: 800;
      opacity: .85;
      font-size: 12px;
    }

    .input-group {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      margin-bottom: 20px;
    }

    input, select {
      padding: 12px 15px;
      border: 2px solid #E5E7EB;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
      background: #fff;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--brand);
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary { 
      background: var(--brand-blue); 
      color: white;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 10px 24px rgba(29,78,216,0.20);
    }
    .btn-primary:hover {
      background: var(--brand-blue-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(37, 97, 193, 0.30);
    }
    .btn-primary:disabled{
      opacity: .75;
      cursor: not-allowed;
    }
    .btn-danger { background: #EF4444; color: white; }
    .btn-danger:hover { background: #DC2626; }
    .btn-warn { background: #F59E0B; color: #fff; }
    .btn-warn:hover { background: #D97706; }
    .btn-gray { background: #6B7280; color: #fff; }
    .btn-gray:hover { background: #4B5563; }
    .btn-gray:disabled{
      opacity: .75;
      cursor: not-allowed;
    }
    .btn-dark { background: #111827; color: #fff; }
    .btn-dark:hover { background: #0B1220; }

    .card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-left: 4px solid;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }
    .card-title {
      font-size: 20px;
      font-weight: 900;
      color: #1F2937;
    }
    .card-subtitle {
      color: #6B7280;
      margin-top: 5px;
      font-weight: 700;
    }

    .truck-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    .badge {
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.3s;
      background: #E5E7EB;
      color: #374151;
    }
    .badge:hover { background: #D1D5DB; }
    .badge.active { background: #10B981; color: white; }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    .section-box {
      background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
      padding: 30px;
      border-radius: 15px;
      max-width: 900px;
      margin: 0 auto;
    }
    .list-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      gap: 10px;
    }
    .list-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .empty-state {
      text-align: center;
      padding: 30px 10px;
      color: #9CA3AF;
      font-style: italic;
      font-weight: 700;
    }
    .mini-status {
      background: #fff;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      font-size: 14px;
      color: #374151;
      line-height: 1.35;
      font-weight: 700;
    }
    .mini-status strong { color: #111827; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
    }
    .modal-backdrop.active { display: flex; }
    .modal {
      width: min(1100px, 96vw);
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .modal-header {
      display:flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 18px;
      background: #F9FAFB;
      border-bottom: 1px solid #E5E7EB;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 950;
      color: #111827;
    }
    .modal-body { padding: 14px 18px 18px 18px; }

    #osrm-modal-map {
      width: 100%;
      height: 520px;
      border-radius: 14px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .modal-actions {
      display:flex;
      gap: 10px;
      margin-top: 12px;
    }

    .popup {
      width: min(520px, 96vw);
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .popup-body {
      padding: 18px;
      color: #111827;
      font-weight: 800;
      line-height: 1.35;
    }
    .popup-actions {
      padding: 14px 18px 18px 18px;
      display:flex;
      justify-content: flex-end;
      gap: 10px;
      background: #F9FAFB;
      border-top: 1px solid #E5E7EB;
    }

    #auth-modal .modal{
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 24px 70px rgba(0,0,0,0.28);
    }

    #auth-modal .auth-header{
      padding: 10px 20px 10px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      border-bottom: 1px solid #E5E7EB;
    }

    #auth-modal .auth-logo{
      width: 140px;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,0.18));
      margin-top: 0;
      margin-bottom: 2px;
    }

    #auth-modal .auth-title{
      font-size: 18px;
      font-weight: 950;
      color: #0F172A;
      letter-spacing: -0.2px;
      margin-top: 0;
    }

    #auth-modal .auth-subtitle{
      font-size: 12px;
      font-weight: 900;
      color: #64748B;
      text-align: center;
      line-height: 1.35;
      margin-top: -4px;
    }

    #auth-modal .modal-body{
      padding-top: 16px;
    }

    #auth-modal input{
      border-radius: 12px;
    }

    #auth-modal .modal-actions button{
      border-radius: 12px;
    }

    #auth-modal .mini-status{
      border-radius: 12px;
    }

    .spinner{
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.55);
      border-top-color: rgba(255,255,255,0.95);
      display: inline-block;
      animation: spin 0.85s linear infinite;
      vertical-align: -3px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .btn-loading{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // === Supabase init ===
    window.supabaseClient = window.supabase.createClient(
      "https://nhvprvgxnlrfulztxcnk.supabase.co", 
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5odnBydmd4bmxyZnVsenR4Y25rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjU0MjQsImV4cCI6MjA4MjM0MTQyNH0.al3zG6OkC5uLe4MLEZeTErmSty-N3yG9rKVDC7FIVWU"
    );
  </script>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <img class="header-logo"
          src="https://cdn-sites-assets.mziq.com/wp-content/uploads/sites/1475/2025/05/AnyConv.com__Camada_11-1.webp"
          alt="Logo">
        <div>
          <h1>Gerenciamento de Autoriza√ß√£o Especial de Tr√¢nsito</h1>
          <p>Controle trechos autorizados por ve√≠culo</p>
          <div style="margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span style="background:rgba(255,255,255,0.18); padding:8px 12px; border-radius:999px; font-weight:900;">
              üë§ <span id="user-badge">Deslogado</span>
            </span>
            <button id="btn-logout" class="btn btn-dark" style="display:none;">Sair</button>
          </div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab(event,'map')">üó∫Ô∏è Mapa e Filtros</button>
      <button class="tab" onclick="showTab(event,'trucks')">üöõ Placas</button>
      <button class="tab" onclick="showTab(event,'routes')">üìç Trechos</button>
    </div>

    <div class="content">
      <div id="tab-map" class="tab-content active">
        <div class="map-section">
          <div class="sidebar">
            <div class="sidebar-scroll">
              <h2>
                üöõ Filtrar por Placa
                <span class="count-pill">Placas: <span id="plates-count">0</span></span>
              </h2>

              <div style="margin-bottom: 12px;">
                <select id="company-filter" style="width:100%;" onchange="onCompanyFilterChange()">
                  <option value="ALL">Todas as Empresas</option>
                  <option value="POTENCIAL">POTENCIAL</option>
                  <option value="BWT">BWT</option>
                </select>
              </div>

              <div style="margin-bottom: 10px;">
                <input id="plate-search" type="text" placeholder="Buscar placa..." oninput="renderFilters()" style="width:100%;">
              </div>

              <button id="btn-all-routes" class="filter-btn" onclick="selectTruckFilter(null)">
                Todos os Trechos
                <span class="filter-sub" id="all-routes-sub">Sem filtro de placa</span>
              </button>

              <div id="filter-buttons" class="plate-list"></div>

              <div class="legend">
                <h3>
                  Trechos Autorizados
                  <span class="count-pill">Trechos: <span id="routes-count">0</span></span>
                </h3>

                <div class="route-list-scroll">
                  <div id="legend-items"></div>
                </div>
              </div>
            </div>

            <div class="sidebar-footer">
              <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1;" onclick="fitToFilteredRoutes()">üó∫Ô∏è Enquadrar</button>
                <button class="btn btn-gray" style="flex:1;" onclick="resetMapView()">Reset</button>
              </div>
            </div>
          </div>

          <div class="map-wrap">
            <div id="map"></div>
            <div id="map-filter-badge" class="map-badge"></div>
          </div>
        </div>
      </div>

      <div id="tab-trucks" class="tab-content">
        <div class="section-box">
          <h2 style="margin-bottom: 20px;">Gerenciar Placas</h2>

          <div class="input-group" style="grid-template-columns: 220px 1fr auto;">
            <select id="new-truck-company">
              <option value="POTENCIAL">POTENCIAL</option>
              <option value="BWT">BWT</option>
            </select>

            <input type="text" id="new-truck" placeholder="Digite a placa (ex: ABC-1234)" />
            <button class="btn btn-primary" onclick="addTruck()">‚ûï Adicionar</button>
          </div>

          <div class="mini-status" style="margin-top:-6px; margin-bottom: 16px;">
            <strong>Regra:</strong> n√£o √© permitido cadastrar a <strong>mesma placa</strong> duas vezes.
          </div>

          <div id="truck-list"></div>
        </div>
      </div>

      <div id="tab-routes" class="tab-content">
        <div class="section-box">
          <h2 style="margin-bottom: 20px;">Novo Trecho</h2>

          <div style="display:flex; gap:10px; margin-bottom: 15px;">
            <button class="btn btn-dark" style="flex:1;" onclick="openOsrmModal()">üéØ Selecionar no mapa</button>
          </div>

          <div class="form-grid">
            <input type="text" id="route-name" placeholder="Nome do trecho" />
            <select id="route-state"><option value="">Selecione o Estado</option></select>
            <input type="text" id="route-highway" placeholder="Rodovia (ex: BR-101)" />
            <input type="color" id="route-color" value="#3B82F6" />
            <input type="text" id="route-start" placeholder="In√≠cio (opcional)" />
            <input type="text" id="route-end" placeholder="Fim (opcional)" />
          </div>

          <button id="btn-save-route" class="btn btn-primary" onclick="saveRoute()" style="width: 100%;">‚ûï Adicionar Trecho</button>
          <button id="btn-cancel-edit" class="btn btn-gray" onclick="cancelEdit()" style="width: 100%; margin-top: 10px; display:none;">‚Ü© Cancelar Edi√ß√£o</button>

          <div class="mini-status">
            <strong>Dica:</strong> clique em <strong>Selecionar no mapa</strong>, marque <strong>In√≠cio</strong> e <strong>Fim</strong>.
            O trecho ficar√° <strong>exato na rodovia</strong> e destacado.
          </div>
        </div>

        <div style="margin-top: 30px;" id="route-list"></div>

        <div id="osrm-modal" class="modal-backdrop" onclick="closeOsrmModalOnBackdrop(event)">
          <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
              <div class="modal-title">üó∫Ô∏è Selecionar trecho exato na rodovia (OSRM)</div>
              <button class="btn btn-gray" onclick="closeOsrmModal()">‚úñ Fechar</button>
            </div>

            <div class="modal-body">
              <div id="osrm-modal-map"></div>

              <div id="osrm-status" class="mini-status">
                Clique em <strong>Iniciar sele√ß√£o</strong> para marcar In√≠cio e Fim do trecho.
              </div>

              <div class="modal-actions">
                <button class="btn btn-primary" onclick="startOsrmSelection()" style="flex:1;">‚ñ∂Ô∏è Iniciar sele√ß√£o</button>
                <button class="btn btn-warn" onclick="cancelOsrmSelection()" style="flex:1;">üö´ Cancelar sele√ß√£o</button>
                <button class="btn btn-dark" onclick="fitTempOrLastRoute()" style="flex:1;">üîç Enquadrar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="dup-plate-modal" class="modal-backdrop" onclick="closeDupPlateOnBackdrop(event)">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">‚ö†Ô∏è Placa j√° cadastrada</div>
        <button class="btn btn-gray" onclick="closeDupPlateModal()">‚úñ</button>
      </div>
      <div class="popup-body" id="dup-plate-text">
        Essa placa j√° est√° cadastrada.
      </div>
      <div class="popup-actions">
        <button class="btn btn-primary" onclick="closeDupPlateModal()">OK</button>
      </div>
    </div>
  </div>

  <div id="auth-modal" class="modal-backdrop active" onclick="/* bloquear clique fora */">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:540px;">
      <div class="modal-header auth-header">
        <img class="auth-logo" src="https://vivaintra-s3-potencial.s3.amazonaws.com/temp/d39ad6a1bff5ed678d5ae138c597b8d5c3df5993.png" alt="Grupo Potencial">
        <div class="auth-title">Acesso ao Sistema</div>
        <div class="auth-subtitle">Gerenciamento de Autoriza√ß√£o Especial de Tr√¢nsito</div>
      </div>
      <div class="modal-body">
        <div class="mini-status" style="margin-top:0;">
          Entre com seu e-mail e senha.
        </div>

        <div style="display:grid; gap:10px; margin-top:14px;">
          <input id="auth-email" type="email" placeholder="E-mail" autocomplete="email" />
          <input id="auth-password" type="password" placeholder="Senha" autocomplete="current-password" />
        </div>

        <div id="auth-status" class="mini-status" style="margin-top:14px; color:#374151; display:none;"></div>
      </div>
      
      <div class="modal-actions" style="padding: 0 18px 18px 18px;">
        <button id="auth-login-btn" class="btn btn-primary" style="width:100%;">Entrar</button>
      
